---
layout: post
title: "使用C#编写COM和COM+ Application"
date: 2023-11-14 19:00:00
categories: "C#"
catalog: true
tags:
  - C#
---

# COM基础知识
Microsoft 组件对象模型 (COM) 是一个独立于平台的分布式面向对象的系统，用于创建可以交互的二进制软件组件。它定义了一个二进制互操作性标准，用于创建在运行时交互的可重用软件库。  
COM 定义 COM 对象的基本性质。 通常，软件对象由一组数据和操作数据的函数组成。 COM 对象是一个对象，在该对象中，只能通过一组或多组相关函数访问对象的数据。 这些函数集称为 接口，接口的函数称为 方法。 此外，COM 要求访问接口方法的唯一方法是通过指向 接口的指针。   
COM 独立于实现语言，这意味着可以通过使用不同的编程语言（如 C++ 和 .NET Framework中的编程语言）创建 COM 库。  

## 对象和接口
COM 对象通过 接口公开其功能，接口是成员函数的集合。 COM 接口定义组件的预期行为和职责，并指定提供一小部分相关操作的强类型协定。 COM 组件之间的所有通信都通过接口进行，组件提供的所有服务都通过其接口公开。 调用方只能访问接口成员函数。 内部状态对调用方不可用，除非它在接口中公开。   
接口是强类型。 每个接口都有其自己唯一的接口标识符（名为 IID）.IID 是 GUID (全局唯一标识符)。 创建新接口时，必须为该接口创建新的标识符。 当调用方使用接口时，它必须使用唯一标识符。    
定义新接口时，可以使用接口定义语言 (IDL) 来创建接口定义。Microsoft 提供的 IDL 基于 DCE IDL 的简单扩展，DCE IDL 是远程过程调用 (RPC) 分布式计算的行业标准。  

## IUnknown 接口
所有 COM 接口都继承自 IUnknown 接口。 IUnknown 接口有三个成员函数，名为 QueryInterface、AddRef 和 Release。  
QueryInterface 成员函数为 COM 提供多态性。 调用 QueryInterface 以在运行时确定 COM 对象是否支持特定接口。 如果 COM 对象实现请求的接口， ppvObject 则它将返回 参数中的接口指针，否则返回 NULL  


# COM
C# 注册COM对象需要声明类接口、“事件接口”（如有必要）和类本身。 类成员必须遵循一下规则才能在 COM 中显示：

    类必须是公开的。
    属性、方法和事件必须是公开的。
    必须在类接口上声明属性和方法。
    必须在事件接口中声明事件。  

如果该类中声明了其他的公共成员，但没有在接口中声明， 则对 COM 不可见，但它们对其他 .NET 对象可见。 
如果想对 COM 公开属性和方法，则必须在类接口上声明这些属性和方法，将它们标记为 DispId 属性，并在类中实现它们。你在接口中声明的成员的顺序是用于 COM vtable 的顺序。   
示例：  

    using System.Runtime.InteropServices;

    namespace project_name
    {
        [Guid("EAA4976A-45C3-4BC5-BC0B-E474F4C3C83F")]
        public interface ComClass1Interface
        {
        }

        [Guid("0D53A3E8-E51A-49C7-944E-E72A2064F938"),
            ClassInterface(ClassInterfaceType.None)]
        public class ComClass1 : ComClass1Interface
        {
        }
    }

## Register
### Register for COM Interop
The `Register for COM interop` 项目属性指定是否将你的应用程序公开为COM对象 (a COM-callable wrapper 一个COM可调用包装器) 从而允许其他COM对象与你的应用程序进行交互。

在C#工程里，该属性是在Build选项页里。  
![image](https://github.com/kerwenzhang/kerwenzhang.github.io/blob/master/_posts/image/comP1.png?raw=true)  

This options executes regasm on the assembly and registers the assembly as an COM component(or maybe not) in the registry with all COM like registry entries.

### Make assembly COM visible  
在C#里还有另外一个属性，在项目属性 > Application tab > Assembly Information button > check "Make assembly COM-Visible".  
![image](https://github.com/kerwenzhang/kerwenzhang.github.io/blob/master/_posts/image/comP2.png?raw=true)  

`Make assembly COM visible` 使得程序集里所有public方法都COM可见，但我们在实际中很少这样操作，通常只在需要COM可见的方法上设置`ComVisible`属性。

    [ComVisible(true)]
    public interface IMyInterface
    {
    }

`Register for COM interop` 相当于执行 `regasm`，将程序集注册为注册表中的 COM 组件。  
当编译生成dll后，需要对其进行注册，这样COM客户端才能找到它。每个COM Object都有一个唯一标识GUID，需要找出是哪个 DLL 实现了它。这些信息都记录在注册表 `HKLM\Software\Classes\CLSID\{guid}` 。  
![image](https://github.com/kerwenzhang/kerwenzhang.github.io/blob/master/_posts/image/comP3.png?raw=true)  

可以通过运行 `Regasm.exe /codebase /tlb xxx.dll` 来完成此操作，也可以直接勾选此选线，让VS自动完成。VS会在编译前先反注册掉旧的接口，编译成功后重新注册新的dll，这样可以防止注册表污染。  


# COM+
## Enterprise Service

# Reference
COM:  
[COM指南 official](https://learn.microsoft.com/zh-cn/windows/win32/com/guide)   
[Example COM Class](https://learn.microsoft.com/en-us/dotnet/csharp/advanced-topics/interop/example-com-class)   
[How to: Register a Component for COM Interop](https://learn.microsoft.com/en-us/previous-versions/visualstudio/visual-studio-2010/w29wacsy(v=vs.100))  
["Register for COM Interop" vs "Make assembly COM visible"](https://stackoverflow.com/questions/3699767/register-for-com-interop-vs-make-assembly-com-visible)  
[COM编程攻略](https://www.zhihu.com/column/c_1234485736897552384)  
[Turn a simple C# DLL into a COM interop component](https://stackoverflow.com/questions/7092553/turn-a-simple-c-sharp-dll-into-a-com-interop-component)   
[Building COM Objects in C#](https://www.codeproject.com/Articles/7859/Building-COM-Objects-in-C)   
[C# Com and COM+](https://www.codeproject.com/Articles/18939/C-Com)  

COM+   
[COM+ official](https://learn.microsoft.com/zh-cn/windows/win32/cossdk/component-services-portal)  
[Creating COM+ Objects using EnterpriseServices in .NET](https://www.codeproject.com/Articles/3845/Creating-COM-Objects-using-EnterpriseServices-in-N)    
[Creating a Simple COM+ Application](https://csharpaid.com/creating-a-simple-com-application-13633)  
[Building a complete COM+ Server component using C# and .NET](https://gsraj.tripod.com/dotnet/complus/complus.net_accountmanager.html)   
[C#中写COM+组件](https://www.cnblogs.com/steven_lwb/archive/2005/07/18/195440.html?utm_source=tuicool)   
[Accessing COM+ component using C#](https://www.codeproject.com/Articles/1511/Accessing-COM-component-using-C)   
[C# Com and COM+](https://www.codeproject.com/Articles/18939/C-Com)  
[Creating a Sample COM+ Service](https://www.informit.com/articles/article.aspx?p=170910&seqNum=2)   
[Building a complete COM+ Server component using C# and .NET](https://gsraj.tripod.com/dotnet/complus/complus.net_accountmanager.html)  
[.NET Serviced Components](http://diranieh.com/NETAdvanced/ServicedComponents.htm)   
 